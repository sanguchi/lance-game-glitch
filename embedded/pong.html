<html>
    <head>
        <title>Simple Pong Game</title>
        <script src="/socket.io/socket.io.js"></script>
        <script src="dist/lance-gg.js"></script>
    </head>
    <body>
        <div style="width: 400px; height: 400px; background: black">
            <div style="position:absolute;width:10px;height:50px;background:white" id="gameobj1" class="paddle1"></div>
            <div style="position:absolute;width:10px;height:50px;background:white" id="gameobj2" class="paddle2"></div>
            <div style="position:absolute;width:5px; height:5px; background:white" id="gameobj3" class="ball"></div>
        </div>

        <script>

        LANCE.on('client__connected', pong);
        function pong() {

            // define object types, passing the networked attributes and options
            LANCE.defineObject('Ball', {}, { bendingVelocityMultiple: 0 });
            LANCE.defineObject('Paddle', {}, {});
            var PADDING = 20, WIDTH = 400, HEIGHT = 400, PADDLE_WIDTH = 10, PADDLE_HEIGHT = 50;
            var localBall = null;
            var localPaddle = null;
            var pressedKeys = {};

            // create the objects as players join
            //
            // 1. First player to join will create and control his own paddle
            // 2. Second player to join will create and control his own paddle and the ball
            //
            LANCE.on('playerJoined', function(ev) {
                if (ev.playerCount === 1) {
                    localPaddle = LANCE.newObject('Paddle', { id: 1 });
                    localPaddle.position.set(PADDING, 0);
                    LANCE.gameEngine.addObjectToWorld(localPaddle);
                } else if (ev.playerCount === 2) {
                    localPaddle = LANCE.newObject('Paddle', { id: 2 });
                    localBall = LANCE.newObject('Ball', { id: 3 });
                    localPaddle.position.set(WIDTH - PADDING, 0);
                    localBall.position.set(WIDTH / 2, HEIGHT / 2);
                    localBall.velocity.set(2,2);
                    LANCE.gameEngine.addObjectToWorld(localPaddle);
                    LANCE.gameEngine.addObjectToWorld(localBall);
                }
            });

            // on each step
            LANCE.on('postStep', function() {

                if (!localPaddle) return;

                // process user inputs at the end of this step
                if (pressedKeys.up) localPaddle.position.y -= 5;
                else if (pressedKeys.down) localPaddle.position.y += 5;

                // update objects controlled by this client on the server
                if (localPaddle) LANCE.updateObjectOnServer(localPaddle);
                if (localBall) LANCE.updateObjectOnServer(localBall);

                // check game rules
                var paddle1 = LANCE.gameEngine.world.objects[1];
                var paddle2 = LANCE.gameEngine.world.objects[2];
                var ball = LANCE.gameEngine.world.objects[3];
                if (paddle1 && paddle2 && ball) {
                    checkPaddleHit(paddle1, paddle2, ball);
                    checkWallHit(paddle1, paddle2, ball);
                }
            });

            function checkPaddleHit(paddle1, paddle2, ball) {
                // CHECK LEFT EDGE:
                if (ball.position.x <= PADDING + PADDLE_WIDTH &&
                    ball.position.y >= paddle1.y && ball.position.y <= paddle1.position.y + PADDLE_HEIGHT &&
                    ball.velocity.x < 0) {
                    // ball moving left hit player 1 paddle
                    ball.velocity.x *= -1;
                    ball.position.x = PADDING + PADDLE_WIDTH + 1;
                }
                // CHECK RIGHT EDGE:
                if (ball.position.x >= WIDTH - PADDING - PADDLE_WIDTH &&
                    ball.position.y >= paddle2.position.y && ball.position.y <= paddle2.position.y + PADDLE_HEIGHT &&
                    ball.velocity.x > 0) {
                    // ball moving right hits player 2 paddle
                    ball.velocity.x *= -1;
                    ball.position.x = WIDTH - PADDING - PADDLE_WIDTH - 1;
                }
            }

            function checkWallHit(paddle1, paddle2, ball) {
                // check left and right walls
                if (ball.position.x <= 0) {
                    ball.velocity.x *= -1;
                    ball.position.x = 0;
                    console.log(`player 2 scored`);
                } else if (ball.position.x >= WIDTH ) {
                    ball.velocity.x *= -1;
                    ball.position.x = WIDTH - 1;
                    console.log(`player 1 scored`);
                }
                // check top and bottom walls
                if (ball.position.y <= 0) {
                    ball.position.y = 1;
                    ball.velocity.y *= -1;
                } else if (ball.position.y >= HEIGHT) {
                    ball.position.y = HEIGHT - 1;
                    ball.velocity.y *= -1;
                }
            }

            // update sprite positions
            LANCE.on('client__draw', function() {
                LANCE.gameEngine.world.forEachObject(function(id, obj) {
                    var el = document.querySelector('#gameobj' + id);
                    el.style.left = LANCE.gameEngine.world.objects[id].position.x + 'px';
                    el.style.top = LANCE.gameEngine.world.objects[id].position.y + 'px';
                });
            });

            // handle inputs
            document.onkeydown = (e) => { onKeyChange(e, true); };
            document.onkeyup = (e) => { onKeyChange(e, false); };
            function onKeyChange(e, isPressed) {
                e = e || window.event;

                if (e.keyCode == '38') {
                    pressedKeys.up = isPressed;
                } else if (e.keyCode == '40') {
                    pressedKeys.down = isPressed;
                }
            }
        }
        </script>
    </body>
</html>
